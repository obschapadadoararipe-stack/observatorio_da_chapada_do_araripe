---
title: "Observatorio da Chapada"
author: "Victor Arraes Rocha Felix"
output: html_document
date: "2026-02-08"
---
```{r}
library(shiny)
library(terra)
library(leaflet)
library(sf)

# -------------------------
# Chapada do Araripe bbox
# -------------------------
bbox_ext <- ext(
  -41.105201, -38.971922,
  -7.943965,  -6.999838
)

# -------------------------
# Raster files by year
# -------------------------
raster_files <- list.files(
  "MapBiomas",
  pattern = "^MapBiomas_LULC_\\d{4}_Araripe\\.tif$",
  full.names = TRUE
)

years <- sub(".*_(\\d{4})_.*", "\\1", raster_files)
years_num <- as.numeric(years)
names(raster_files) <- years_num

# -------------------------
# Shapefile Chapada
# -------------------------
municipios_araripe <- st_read("mapa_da_chapada/chapada_above650.shp", quiet = TRUE)
municipios_araripe <- st_transform(municipios_araripe, 4326)

# -------------------------
# Classes realmente presentes
# -------------------------
classes <- c(0,3,4,12,15,21,23,24,25,29,30,33,39,41,75)

natural_classes <- c(3,4,12)
farming_classes <- c(15,21,39,41)
urban_classes   <- c(23,24,30,75)
no_veg_classes  <- c(0,25,29)
water_classes   <- c(33)

group_df <- data.frame(
  from = classes,
  to = ifelse(classes %in% natural_classes, 1,
       ifelse(classes %in% farming_classes, 2,
       ifelse(classes %in% urban_classes,   3,
       ifelse(classes %in% no_veg_classes,  4,
       ifelse(classes %in% water_classes,   5, NA)))))
)

group_mat <- as.matrix(group_df)

# =========================
# UI
# =========================
ui <- fluidPage(

  tags$h1("Observatório da Chapada do Araripe", align="center"),

  fluidRow(
    column(10, offset=1,

      tabsetPanel(

        # =========================
        # TAB MAPA
        # =========================
        tabPanel("Chapada do Araripe",

          fluidRow(
            column(9,
              # Title above the map
              tags$h2("Salve a Chapada!", style="text-align:center;"),
              tags$p(
                "O mapa mostra as mudanças de uso e cobertura da terra entre 2000 e 2024. Explore os anos deslizando o controle abaixo para observar as alarmantes alterações!",
                style="text-align:center; margin-bottom:15px;"
              ),

              # Map
              leafletOutput("mapGrouped", height = 600)
            ),

            column(3,
              tags$div(
                style="border:1px solid #ccc;padding:20px;border-radius:8px;",
                tags$h4("Legenda"),
                tags$ul(
                  tags$li(span(style="color:darkgreen;font-weight:bold;","■ "), "Vegetação"),
                  tags$li(span(style="color:red;font-weight:bold;","■ "), "Agropecuária"),
                  tags$li(span(style="color:yellow;font-weight:bold;","■ "), "Área Urbana"),
                  tags$li(span(style="color:gray;font-weight:bold;","■ "), "Sem Vegetação"),
                  tags$li(span(style="color:blue;font-weight:bold;","■ "), "Água")
                )
              )
            )
          ),

          # Slider below the map
          fluidRow(
            column(12,
              div(style="text-align:center;",
                div(style="display:inline-block;width:60%;",
                  sliderInput("year","",
                    min=min(years_num),
                    max=max(years_num),
                    value=max(years_num),
                    step=1, sep=""
                  ),
                  tags$p("Deslize para observar as mudanças ao longo dos anos")
                )
              )
            )
          )

        ),

        # =========================
        # TAB DADOS
        # =========================
        tabPanel("Dados e Metodos",

          tags$h3("Fonte"),
          tags$p(
            "Dados do MapBiomas – Coleção 10 da série anual de Mapas de Cobertura e Uso da Terra do Brasil, acessado em 07/02/2026 através do link: ",
            tags$a(
              href = "https://developers.google.com/earth-engine/datasets/catalog/projects_mapbiomas-public_assets_brazil_lulc_v1",
              "Google Earth Engine – MapBiomas",
              target = "_blank"
            ),
            ". Artigo sobre os dados disponível em: ",
            tags$a(
              href = "https://doi.org/10.3390/rs12172735",
              "DOI: 10.3390/rs12172735",
              target = "_blank"
            )
          ),

          tags$h3("Agrupamento das Classes"),
          tags$ul(
            tags$li(tags$b("Vegetação Natural:")," Formação Florestal (3), Formação Savânica (4), Formação Campestre (12)"),
            tags$li(tags$b("Agropecuária:")," Pastagem (15), Mosaico de Usos (21), Soja (39), Outras Lavouras Temporarias (41)"),
            tags$li(tags$b("Área Urbana ou Infraestrutura:")," Areal (23) ,Área Urbana (24), Mineração (30) e Usina Fotovoltaica (75)"),
            tags$li(tags$b("Sem Vegetação:")," Outras Áreas Não Vegetadas (25), Não observado (0) e Afloramento Rochoso (29)"),
            tags$li(tags$b("Água:")," Corpos d’água (33)")
          ),

          tags$p("Apenas classes realmente presentes nos rasters da região foram consideradas."),

          tags$h3("Topografia (> 650 m)"),
          tags$p(
            "O mapa da Chapada do Araripe foi feito usando áreas acima de 650 metros de altitude e foi gerado em R a partir de dados de elevação obtidos via pacote ",
            tags$a("elevatr", href="https://cran.r-project.org/package/elevatr", target="_blank"),
            ", que acessa modelos digitais de elevação globais (DEM) com dados abertos."
          ),

          tags$h3("Processamento de Dados"),
          tags$p(
            "Todo o processamento dos dados raster e vetoriais foi realizado em R, utilizando os pacotes ",
            tags$b("terra"), ", ", tags$b("sf"), " e ", tags$b("elevatr"), 
            ". O site interativo foi desenvolvido em R com o pacote ", tags$b("shiny"), " e utiliza ", tags$b("leaflet"), " para visualização dos mapas."
          )

        ),

        # =========================
        # TAB CONTRIBUA
        # =========================
        tabPanel("Contribua",
          
          tags$h2("Participe do Observatório!", style="text-align:center;"),
         tags$h3(
            "Estamos abertos para contribuições de líderes comunitários, estudantes, pesquisadores, professores, gestores e de toda a população Caririense interessada em contribuir para uma ocupação consciente deste nosso território ancestral.",
            style="text-align:center; margin-bottom:15px;"
          ),
          
      
          tags$a(
            "Entre em contato!",
            href="https://forms.gle/JfxvYWxu4feohTy3A",
            target="_blank",
            style="font-weight:bold;font-size:16px; display:block; text-align:center; margin-top:15px;"
          )
        )

      )
    )
  ),

  # =========================
  # FOOTER
  # =========================
  tags$footer(
    "Por um desenvolvimento para todos.",
    style = "text-align:center; padding:15px; font-size:14px; color:gray; border-top:1px solid #ccc; margin-top:20px;"
  )
)

# =========================
# SERVER
# =========================
server <- function(input, output, session){

  current_raster <- reactive({
    req(input$year)
    crop(rast(raster_files[as.character(input$year)]), bbox_ext)
  })

  grouped_raster <- reactive({
    classify(current_raster(), group_mat, others=NA)
  })

  # render once
  output$mapGrouped <- renderLeaflet({

    center_lng <- (-41.105201 + -38.971922)/2
    center_lat <- (-7.943965 + -6.999838)/2

    leaflet() %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      setView(center_lng, center_lat, zoom=9)
  })

  # update without resetting zoom
  observe({

    pal <- colorFactor(
      c("darkgreen","red","yellow","gray","blue"),
      domain = 1:5
    )

    leafletProxy("mapGrouped") %>%
      clearImages() %>%
      addRasterImage(grouped_raster(),
                     colors=pal,
                     opacity=1,
                     method="ngb") %>%
      clearShapes() %>%
      addPolygons(
        data = municipios_araripe,
        color="black",
        weight=4,
        opacity=1,
        fill=FALSE
      )

  })

}

# =========================
# Run App
# =========================
shinyApp(ui, server)
```

